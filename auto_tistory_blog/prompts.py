# prompts.py
def build_prompt_json(category: str, article: dict) -> str:
    """
    Ollama에게 '구조화된 JSON'으로 결과만 출력하게 만드는 프롬프트.
    목표: 기사 내용을 '복사/반복'하지 않고, 사실 기반으로 자연스러운 블로그 글을 생성할 수 있게 함.

    핵심 변경점:
    - 본문(body)을 '요약 문장 1 / 배경과 맥락 / 쟁점과 의미 / 결론' 같은 라벨로 쓰지 않도록 유도
    - 대신 summary/context/analysis/conclusion 필드로 분리해 JSON으로 받고,
      generator.py에서 하나의 글로 합성(post)한다.
    - 환각(없는 인물/관계/수치/날짜/발언) 강력 억제
    - 저작권/법적 리스크 줄이기: 원문 문장 그대로 복사 금지, 직접 인용 최소화
    """

    title = (article.get("title") or "").strip()
    source = (article.get("source") or "").strip()
    pubdate = (article.get("date") or "").strip()
    lead = (article.get("lead") or "").strip()
    excerpt = (article.get("excerpt") or "").strip()

    # ===== 공통 규칙 =====
    base_rules = f"""
[역할]
너는 '뉴스 기반 블로그 에디터'다. 아래 뉴스 입력만 근거로, 사실 기반의 글을 만든다.

[절대 규칙 (환각 방지)]
- 입력에 없는 인물/관계/연애/발언/수치/연봉/연도/날짜/순위/원인-결과를 만들어내지 마라.
- 모르면 쓰지 마라. 대신 '기사에서 확인되지 않는다'로 처리한다.
- 추측/단정/루머/사생활 캐묘사 금지. (특히 연예/스포츠 인물)
- 정치/사회 이슈는 중립 유지. 편가르기, 선동, 혐오 표현 금지.
- 원문 문장을 그대로 베끼지 마라. (동일/유사 문장 반복도 금지)
- 직접 인용은 최대 1문장, 꼭 필요한 경우에만 따옴표로. (없으면 인용하지 말 것)

[언어/표기]
- 한국어로 작성한다.
- URL/도메인/영문 문장 남발 금지. (고유명사·약어는 필요 최소로만)
- '요약 문장 1', '배경과 맥락', '쟁점과 의미', '결론' 같은 섹션 라벨을 본문에 쓰지 마라.
- 구분선(────)도 절대 쓰지 마라.

[출력 형식]
- 반드시 JSON 객체 1개만 출력한다. (추가 설명/마크다운/코드블록 금지)
""".strip()

    # ===== 카테고리별 보정 규칙(짧게) =====
    category_rules = """
[카테고리 톤]
- 공통: 담백하고 읽기 쉬운 문장, 같은 내용 반복 금지.
- 스포츠: 경기/선수 관련 사실은 입력에 있을 때만. 개인사/사생활 추측 금지.
- 연예/문화: 작품/행사 사실 중심. 평가는 과장 없이, 근거 없이 '대성공' 단정 금지.
- 정치/사회: 맥락 설명은 하되, 결론을 강요하지 않는다.
- 경제/IT: 수치/지표는 입력에 있을 때만. 없으면 숫자를 만들지 않는다.
""".strip()

    # ===== JSON 스키마 =====
    json_schema = """
[JSON 스키마]
{
  "title": "블로그 글 제목 (8~80자, 과장/낚시 금지)",
  "summary": ["요약 1문장", "요약 1문장", "요약 1문장"],
  "context": ["배경/맥락 문단", "배경/맥락 문단"],
  "analysis": ["쟁점/의미 문단", "쟁점/의미 문단"],
  "conclusion": "마무리 1~2문장 (단정/추측 금지)",
  "caution": "기사에 없는 건 쓰지 않았는지 자체 점검 1문장"
}

[작성 가이드]
- summary는 서로 겹치지 않게 3문장.
- context/analysis는 각각 2문단. 문단마다 새 정보가 있어야 한다.
- conclusion은 '정리 + 다음 관전 포인트' 정도로 짧게.
- 입력이 빈약하면 '기사에서 확인되지 않는다'를 사용해 빈칸을 메워라(하지만 상상 금지).
""".strip()

    prompt = f"""
{base_rules}

{category_rules}

{json_schema}

[뉴스 입력]
- 제목: {title}
- 매체: {source}
- 날짜: {pubdate}

[기사 단서(참고용)]
- 아래 내용은 참고만 하며, 문장을 그대로 복사하면 실패한다.
- 메타 요약: {lead}
- 발췌 단서: {excerpt}

이제 조건을 모두 만족하는 JSON 객체 1개만 출력하라.
""".strip()

    return prompt
